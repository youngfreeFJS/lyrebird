<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>示例 | Lyrebird</title>
    <meta name="description" content="面向移动应用的插件式测试工作台">
    <meta name="generator" content="VuePress 1.3.0">
    
    
    <link rel="preload" href="/lyrebird/assets/css/0.styles.9be44e31.css" as="style"><link rel="preload" href="/lyrebird/assets/js/app.4d11595d.js" as="script"><link rel="preload" href="/lyrebird/assets/js/2.5879ac39.js" as="script"><link rel="preload" href="/lyrebird/assets/js/21.b61efce2.js" as="script"><link rel="prefetch" href="/lyrebird/assets/js/10.470eccb4.js"><link rel="prefetch" href="/lyrebird/assets/js/11.4f3dd3b3.js"><link rel="prefetch" href="/lyrebird/assets/js/12.f9935de1.js"><link rel="prefetch" href="/lyrebird/assets/js/13.91d24526.js"><link rel="prefetch" href="/lyrebird/assets/js/14.5f85e836.js"><link rel="prefetch" href="/lyrebird/assets/js/15.e9ecb74e.js"><link rel="prefetch" href="/lyrebird/assets/js/16.9c130105.js"><link rel="prefetch" href="/lyrebird/assets/js/17.84543903.js"><link rel="prefetch" href="/lyrebird/assets/js/18.330f2ee6.js"><link rel="prefetch" href="/lyrebird/assets/js/19.9772f277.js"><link rel="prefetch" href="/lyrebird/assets/js/20.4411ba62.js"><link rel="prefetch" href="/lyrebird/assets/js/22.2eb21844.js"><link rel="prefetch" href="/lyrebird/assets/js/23.25a7e780.js"><link rel="prefetch" href="/lyrebird/assets/js/24.3cccf37b.js"><link rel="prefetch" href="/lyrebird/assets/js/25.d5f15427.js"><link rel="prefetch" href="/lyrebird/assets/js/26.ad4ebaf2.js"><link rel="prefetch" href="/lyrebird/assets/js/27.f510b62a.js"><link rel="prefetch" href="/lyrebird/assets/js/28.85561fd9.js"><link rel="prefetch" href="/lyrebird/assets/js/29.2e118348.js"><link rel="prefetch" href="/lyrebird/assets/js/3.68153931.js"><link rel="prefetch" href="/lyrebird/assets/js/30.f7e309d4.js"><link rel="prefetch" href="/lyrebird/assets/js/4.298fd8c4.js"><link rel="prefetch" href="/lyrebird/assets/js/5.ddbda7d6.js"><link rel="prefetch" href="/lyrebird/assets/js/6.3f838b19.js"><link rel="prefetch" href="/lyrebird/assets/js/7.f1e58e36.js"><link rel="prefetch" href="/lyrebird/assets/js/8.148e98ff.js"><link rel="prefetch" href="/lyrebird/assets/js/9.6588b17e.js">
    <link rel="stylesheet" href="/lyrebird/assets/css/0.styles.9be44e31.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/lyrebird/" class="home-link router-link-active"><!----> <span class="site-name">Lyrebird</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/lyrebird/guide/" class="nav-link">
  指南
</a></div><div class="nav-item"><a href="/lyrebird/checker/" class="nav-link router-link-active">
  检查器
</a></div><div class="nav-item"><a href="/lyrebird/plugins/" class="nav-link">
  插件
</a></div><div class="nav-item"><a href="/lyrebird/advance/" class="nav-link">
  高级
</a></div><div class="nav-item"><a href="/lyrebird/develop/" class="nav-link">
  开发者指南
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="代码仓库" class="dropdown-title"><span class="title">代码仓库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/Meituan-Dianping/lyrebird" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Lyrebird
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/Meituan-Dianping/lyrebird-ios" target="_blank" rel="noopener noreferrer" class="nav-link external">
  iOS
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/Meituan-Dianping/lyrebird-android" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Android
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/Meituan-Dianping/lyrebird-api-coverage" target="_blank" rel="noopener noreferrer" class="nav-link external">
  ApiCoverage
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/Meituan-Dianping/lyrebird-tracking" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Tracking
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/lyrebird/guide/" class="nav-link">
  指南
</a></div><div class="nav-item"><a href="/lyrebird/checker/" class="nav-link router-link-active">
  检查器
</a></div><div class="nav-item"><a href="/lyrebird/plugins/" class="nav-link">
  插件
</a></div><div class="nav-item"><a href="/lyrebird/advance/" class="nav-link">
  高级
</a></div><div class="nav-item"><a href="/lyrebird/develop/" class="nav-link">
  开发者指南
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="代码仓库" class="dropdown-title"><span class="title">代码仓库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/Meituan-Dianping/lyrebird" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Lyrebird
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/Meituan-Dianping/lyrebird-ios" target="_blank" rel="noopener noreferrer" class="nav-link external">
  iOS
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/Meituan-Dianping/lyrebird-android" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Android
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/Meituan-Dianping/lyrebird-api-coverage" target="_blank" rel="noopener noreferrer" class="nav-link external">
  ApiCoverage
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/Meituan-Dianping/lyrebird-tracking" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Tracking
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/lyrebird/checker/" class="sidebar-link">使用指南</a></li><li><a href="/lyrebird/checker/dev_debug.html" class="sidebar-link">第一个检查器</a></li><li><a href="/lyrebird/checker/examples.html" class="active sidebar-link">示例</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/lyrebird/checker/examples.html#大图检测" class="sidebar-link">大图检测</a></li><li class="sidebar-sub-header"><a href="/lyrebird/checker/examples.html#重复请求检测" class="sidebar-link">重复请求检测</a></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="示例"><a href="#示例" class="header-anchor">#</a> 示例</h1> <p>检查器可以监听Lyrebird<a href="/lyrebird/advance/eventbus.html">消息总线</a>中的任意频道，对其中需要校验的目标数据进行检测。</p> <p>目前，Lyrebird中提供了如下的示例脚本：</p> <table><thead><tr><th style="text-align:left;">Filename</th> <th style="text-align:left;">Channel</th> <th style="text-align:left;">Description</th></tr></thead> <tbody><tr><td style="text-align:left;"><a href="https://github.com/Meituan-Dianping/lyrebird/tree/master/lyrebird/examples/checkers/img_size.py" target="_blank" rel="noopener noreferrer">img_size.py<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></td> <td style="text-align:left;">flow</td> <td style="text-align:left;">检查网络请求中图片大小是否超出限制</td></tr> <tr><td style="text-align:left;"><a href="https://github.com/Meituan-Dianping/lyrebird/tree/master/lyrebird/examples/checkers/duplicate_requests.py" target="_blank" rel="noopener noreferrer">duplicate_requests.py<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></td> <td style="text-align:left;">flow</td> <td style="text-align:left;">检查在某段时间内是否有重复的网络请求</td></tr></tbody></table> <h2 id="大图检测"><a href="#大图检测" class="header-anchor">#</a> 大图检测</h2> <p>在网络请求中，图片是一种高消耗资源的数据，移动设备无需加载过大的图片，因此需要对这类请求的数据进行校验。</p> <p>检查的思路为，监听flow频道，从server.response部分中的头部信息读取图片大小，当图片大小超过阈值500KB时发出报警。</p> <h3 id="忽略无关数据"><a href="#忽略无关数据" class="header-anchor">#</a> 忽略无关数据</h3> <p>仅关注server.response部分的数据，且Content-Type为image的数据。</p> <div class="language-py extra-class"><pre class="language-py"><code><span class="token keyword">from</span> lyrebird <span class="token keyword">import</span> CustomEventReceiver

event <span class="token operator">=</span> CustomEventReceiver<span class="token punctuation">(</span><span class="token punctuation">)</span>

THRESHOLD_IMG_SIZE <span class="token operator">=</span> <span class="token number">500</span>

<span class="token decorator annotation punctuation">@event</span><span class="token punctuation">(</span><span class="token string">'flow'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">img_size</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token comment"># 1.ignore unexepcted object</span>
    <span class="token keyword">if</span> ignore_check<span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span>

<span class="token keyword">def</span> <span class="token function">ignore_check</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> msg<span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'server.response'</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">True</span>
    <span class="token keyword">if</span> <span class="token string">'response'</span> <span class="token keyword">not</span> <span class="token keyword">in</span> msg<span class="token punctuation">[</span><span class="token string">'flow'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">True</span>
    <span class="token keyword">if</span> <span class="token string">'image'</span> <span class="token keyword">not</span> <span class="token keyword">in</span> msg<span class="token punctuation">[</span><span class="token string">'flow'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'response'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'headers'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'Content-Type'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">True</span>
    <span class="token keyword">return</span> <span class="token boolean">False</span>

</code></pre></div><h3 id="获取目标数据"><a href="#获取目标数据" class="header-anchor">#</a> 获取目标数据</h3> <p>从获得的数据集中，获取检测所需的目标数据:</p> <ul><li>size: 图片大小</li></ul> <div class="language-py extra-class"><pre class="language-py"><code><span class="token keyword">from</span> decimal <span class="token keyword">import</span> Decimal
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token decorator annotation punctuation">@event</span><span class="token punctuation">(</span><span class="token string">'flow'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">img_size</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token comment"># 1.ignore unexepcted object</span>
    <span class="token keyword">if</span> ignore_check<span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span>

    <span class="token comment"># 2.prepare useful info</span>
    img_size <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>msg<span class="token punctuation">[</span><span class="token string">'flow'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'size'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    img_size <span class="token operator">=</span> Decimal<span class="token punctuation">(</span>img_size <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">.</span>quantize<span class="token punctuation">(</span>Decimal<span class="token punctuation">(</span><span class="token string">'0.0'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="得出校验结果"><a href="#得出校验结果" class="header-anchor">#</a> 得出校验结果</h3> <p>对目标数据进行校验，当图片大小超过500KB时，发出大图报警。</p> <div class="language-py extra-class"><pre class="language-py"><code><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token decorator annotation punctuation">@event</span><span class="token punctuation">(</span><span class="token string">'flow'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">img_size</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token comment"># 1.ignore unexepcted object</span>
    <span class="token keyword">if</span> ignore_check<span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span>

    <span class="token comment"># 2.prepare useful info</span>
    img_size <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>msg<span class="token punctuation">[</span><span class="token string">'flow'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'size'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    img_size <span class="token operator">=</span> Decimal<span class="token punctuation">(</span>img_size <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">.</span>quantize<span class="token punctuation">(</span>Decimal<span class="token punctuation">(</span><span class="token string">'0.0'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># 3.check data</span>
    <span class="token keyword">if</span> img_size <span class="token operator">&gt;</span> THRESHOLD_IMG_SIZE<span class="token punctuation">:</span>
        img_url <span class="token operator">=</span> msg<span class="token punctuation">[</span><span class="token string">'flow'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'request'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'url'</span><span class="token punctuation">]</span>
        event<span class="token punctuation">.</span>issue<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Image size </span><span class="token interpolation"><span class="token punctuation">{</span>img_size<span class="token punctuation">}</span></span><span class="token string">KB is beyond expectations: </span><span class="token interpolation"><span class="token punctuation">{</span>img_url<span class="token punctuation">}</span></span><span class="token string">\n'</span></span><span class="token punctuation">)</span>
</code></pre></div><h2 id="重复请求检测"><a href="#重复请求检测" class="header-anchor">#</a> 重复请求检测</h2> <p>在一组网络请求中，可能会出现重复请求同一个接口的情况。</p> <p>检查的思路为，监听flow频道，从client.request部分中读取URL，当在200毫秒内发现重复的请求时，则发出重复请求报警。</p> <h3 id="忽略无关数据-2"><a href="#忽略无关数据-2" class="header-anchor">#</a> 忽略无关数据</h3> <p>仅关注client.request部分的数据，且过滤掉不关注的域名。</p> <div class="language-py extra-class"><pre class="language-py"><code><span class="token keyword">from</span> lyrebird <span class="token keyword">import</span> CustomEventReceiver
<span class="token keyword">from</span> urllib<span class="token punctuation">.</span>parse <span class="token keyword">import</span> urlparse

event <span class="token operator">=</span> CustomEventReceiver<span class="token punctuation">(</span><span class="token punctuation">)</span>

IGNORE_HOSTNAME <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">'report.meituan.com'</span><span class="token punctuation">,</span>
    <span class="token string">'frep.meituan.net'</span>
<span class="token punctuation">]</span>

<span class="token decorator annotation punctuation">@event</span><span class="token punctuation">(</span><span class="token string">'flow'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">duplicate_request</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token comment"># 1.ignore unexepcted object</span>
    <span class="token keyword">if</span> ignore_check<span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span>

<span class="token keyword">def</span> <span class="token function">ignore_check</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> msg<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token string">'client.request'</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">True</span>
    <span class="token keyword">if</span> urlparse<span class="token punctuation">(</span>msg<span class="token punctuation">[</span><span class="token string">'flow'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'request'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'url'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hostname <span class="token keyword">in</span> IGNORE_HOSTNAME<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">True</span>
    <span class="token keyword">return</span> <span class="token boolean">False</span>
</code></pre></div><h3 id="获取目标数据-2"><a href="#获取目标数据-2" class="header-anchor">#</a> 获取目标数据</h3> <p>获取校验所需的数据：</p> <ul><li>url：请求的标示，判断是否有重复请求的重要依据。需要过滤掉请求中不关注的参数，并使参数有序排列</li> <li>method： 请求方法</li> <li>request_key：由处理后的url和method生成的串，作为请求的唯一标示</li> <li>time：请求发出的时间</li></ul> <div class="language-py extra-class"><pre class="language-py"><code><span class="token keyword">import</span> hashlib
<span class="token keyword">from</span> urllib<span class="token punctuation">.</span>parse <span class="token keyword">import</span> urlparse<span class="token punctuation">,</span> urlencode<span class="token punctuation">,</span> parse_qsl

IGNORE_PARAMETER <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'token'</span><span class="token punctuation">,</span>
                    <span class="token string">'version_name'</span><span class="token punctuation">,</span>
                    <span class="token string">'uuid'</span>
                    <span class="token punctuation">]</span>

<span class="token decorator annotation punctuation">@event</span><span class="token punctuation">(</span><span class="token string">'flow'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">duplicate_request</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment"># 2.prepare useful info</span>
    origin_url <span class="token operator">=</span> msg<span class="token punctuation">[</span><span class="token string">'flow'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'request'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'url'</span><span class="token punctuation">]</span>
    sorted_url <span class="token operator">=</span> sort_params<span class="token punctuation">(</span>origin_url<span class="token punctuation">[</span>origin_url<span class="token punctuation">.</span>rfind<span class="token punctuation">(</span><span class="token string">'//'</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    request_key_list <span class="token operator">=</span> <span class="token punctuation">[</span>
        sorted_url<span class="token punctuation">,</span>
        msg<span class="token punctuation">[</span><span class="token string">'flow'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'request'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'method'</span><span class="token punctuation">]</span>
    <span class="token punctuation">]</span>
    request_key <span class="token operator">=</span> get_md5_code<span class="token punctuation">(</span>request_key_list<span class="token punctuation">)</span>
    request_time <span class="token operator">=</span> msg<span class="token punctuation">[</span><span class="token string">'time'</span><span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">sort_params</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># serialize parameters and remove ignored parameters</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>urlparse<span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span>query<span class="token punctuation">)</span><span class="token punctuation">:</span>
        origin_parameters <span class="token operator">=</span> parse_qsl<span class="token punctuation">(</span>urlparse<span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span>query<span class="token punctuation">)</span>
        origin_parameters <span class="token operator">=</span> <span class="token punctuation">[</span>param <span class="token keyword">for</span> param <span class="token keyword">in</span> origin_parameters <span class="token keyword">if</span> param<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">not</span> <span class="token keyword">in</span> IGNORE_PARAMETER<span class="token punctuation">]</span>
        origin_parameters<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span>x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> url<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">'?'</span> <span class="token operator">+</span> urlencode<span class="token punctuation">(</span>origin_parameters<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> url

<span class="token keyword">def</span> <span class="token function">get_md5_code</span><span class="token punctuation">(</span>keys<span class="token punctuation">:</span><span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    md5_module <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>sha224<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> key <span class="token keyword">in</span> keys<span class="token punctuation">:</span>
        md5_module<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token builtin">bytes</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> encoding <span class="token operator">=</span> <span class="token string">&quot;utf8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> md5_module<span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="得到校验结果"><a href="#得到校验结果" class="header-anchor">#</a> 得到校验结果</h3> <p>维护一个记录所有历史请求的存储器，若当前请求存在于历史请求中，且两次请求的时间间隔小于200ms，则界定为一次重复请求。</p> <div class="language-py extra-class"><pre class="language-py"><code><span class="token keyword">import</span> time
<span class="token keyword">from</span> collections <span class="token keyword">import</span> OrderedDict

THRESHOLD_TIME <span class="token operator">=</span> <span class="token number">0.2</span>

HISTORY_URL <span class="token operator">=</span> OrderedDict<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@event</span><span class="token punctuation">(</span><span class="token string">'flow'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">duplicate_request</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment"># 3.check data</span>
    <span class="token keyword">if</span> request_key <span class="token keyword">in</span> HISTORY_URL<span class="token punctuation">:</span>
        <span class="token keyword">if</span> request_time <span class="token operator">-</span> HISTORY_URL<span class="token punctuation">[</span>request_key<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'time'</span><span class="token punctuation">]</span> <span class="token operator">&gt;=</span> THRESHOLD_TIME<span class="token punctuation">:</span>
            <span class="token keyword">return</span>

        url <span class="token operator">=</span> HISTORY_URL<span class="token punctuation">[</span>request_key<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'url'</span><span class="token punctuation">]</span>
        event<span class="token punctuation">.</span>issue<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Duplicate request: </span><span class="token interpolation"><span class="token punctuation">{</span>url<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
</code></pre></div><h3 id="更新验证集合"><a href="#更新验证集合" class="header-anchor">#</a> 更新验证集合</h3> <p>维护历史请求数据，将新的请求数据存入历史请求，并删除其中的过期数据。</p> <div class="language-py extra-class"><pre class="language-py"><code><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token decorator annotation punctuation">@event</span><span class="token punctuation">(</span><span class="token string">'flow'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">duplicate_request</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment"># 4.update storage data</span>
    HISTORY_URL<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token punctuation">{</span>
        request_key<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">'time'</span><span class="token punctuation">:</span> request_time<span class="token punctuation">,</span>
            <span class="token string">'url'</span><span class="token punctuation">:</span> sorted_url
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    overdue_urls <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token keyword">in</span> HISTORY_URL<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> value<span class="token punctuation">[</span><span class="token string">'time'</span><span class="token punctuation">]</span> <span class="token operator">&gt;=</span> THRESHOLD_TIME<span class="token punctuation">:</span>
            overdue_urls<span class="token punctuation">.</span>append<span class="token punctuation">(</span>key<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">break</span>
    <span class="token keyword">for</span> overdue_url <span class="token keyword">in</span> overdue_urls<span class="token punctuation">:</span>
        <span class="token keyword">del</span> HISTORY_URL<span class="token punctuation">[</span>overdue_url<span class="token punctuation">]</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/lyrebird/checker/dev_debug.html" class="prev">
        第一个检查器
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/lyrebird/assets/js/app.4d11595d.js" defer></script><script src="/lyrebird/assets/js/2.5879ac39.js" defer></script><script src="/lyrebird/assets/js/21.b61efce2.js" defer></script>
  </body>
</html>
